{% extends 'base.html' %}

{% block content %}
<h1>Create a Route</h1>
<div class="form-check mb-3">
    <input type="checkbox" class="form-check-input" id="use-location">
    <label class="form-check-label" for="use-location">Use my current location as the starting point</label>
</div>
<div id="map" style="height: 500px;"></div>
<div class="mt-3">
    <button id="save-route-btn" class="btn btn-primary">Save Route</button>
    <div id="route-info" class="mt-3"></div>
</div>
{% endblock %}

{% block scripts %}
<!-- Leaflet Control Geocoder Plugin -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<!-- Leaflet Routing Machine Plugin -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<style>
    .delete-icon {
        cursor: pointer;
        color: red;
        font-weight: bold;
    }
</style>

<script>
    var map = L.map('map').setView([51.505, -0.09], 13); // Default location
    var waypoints = [];
    var markers = [];

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    var geocoder = L.Control.Geocoder.nominatim();
    var routingControl = L.Routing.control({
        waypoints: waypoints,
        createMarker: function() { return null; },
        routeWhileDragging: true,
        geocoder: geocoder
    }).addTo(map);

    routingControl.on('routesfound', function(e) {
        var routes = e.routes;
        var summary = routes[0].summary;
        var distance = (summary.totalDistance / 1000).toFixed(2); // in kilometers
        var time = (summary.totalTime / 3600).toFixed(2); // in hours
        document.getElementById('route-info').innerHTML =
            `<strong>Route Distance:</strong> ${distance} km<br><strong>Estimated Travel Time:</strong> ${time} hours`;
    });

    document.getElementById('use-location').addEventListener('change', function() {
        if (this.checked) {
            map.locate({setView: true, maxZoom: 16});
        } else {
            // Remove current location marker if exists
            if (markers.length > 0 && markers[0].options.isCurrentLocation) {
                map.removeLayer(markers[0]);
                markers.shift();
                waypoints.shift();
                routingControl.setWaypoints(waypoints);
            }
        }
    });

    map.on('locationfound', function(e) {
        var latlng = e.latlng;
        var marker = L.marker(latlng, { draggable: true, isCurrentLocation: true }).addTo(map)
            .bindPopup("Current Location<br><span class='delete-icon' onclick='deleteMarker(" + latlng.lat + ", " + latlng.lng + ")'>✖</span>")
            .openPopup();

        waypoints.unshift(latlng);
        markers.unshift(marker);
        routingControl.setWaypoints(waypoints);

        marker.on('dragend', function(event) {
            var marker = event.target;
            var position = marker.getLatLng();
            updateWaypoint(marker, position);
        });
    });

    map.on('locationerror', function(e) {
        alert(e.message);
    });

    var control = L.Control.geocoder({
        query: '',
        placeholder: 'Search for a location...',
        defaultMarkGeocode: false
    })
    .on('markgeocode', function(e) {
        var latlng = e.geocode.center;
        var marker = L.marker(latlng, { draggable: true }).addTo(map)
            .bindPopup('<b>' + e.geocode.name + '</b><br><span class="delete-icon" onclick="deleteMarker(' + latlng.lat + ', ' + latlng.lng + ')">✖</span>')
            .openPopup();

        waypoints.push(latlng);
        markers.push(marker);
        routingControl.setWaypoints(waypoints);

        marker.on('dragend', function(event) {
            var marker = event.target;
            var position = marker.getLatLng();
            updateWaypoint(marker, position);
        });
    })
    .addTo(map);

    function updateWaypoint(marker, position) {
        var index = waypoints.findIndex(function(waypoint) {
            return waypoint.lat === marker._latlng.lat && waypoint.lng === marker._latlng.lng;
        });
        if (index !== -1) {
            waypoints[index] = position;
            routingControl.setWaypoints(waypoints);
        }
    }

    function deleteMarker(lat, lng) {
        var index = waypoints.findIndex(function(waypoint) {
            return waypoint.lat === lat && waypoint.lng === lng;
        });
        if (index !== -1) {
            waypoints.splice(index, 1);
            routingControl.setWaypoints(waypoints);
            var marker = markers[index];
            map.removeLayer(marker);
            markers.splice(index, 1);
        }
    }

    function saveRoute() {
        var routeName = prompt("Enter route name:");
        if (routeName) {
            fetch('/save_route', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ name: routeName, waypoints: waypoints })
            }).then(response => response.json())
              .then(data => alert(data.message))
              .catch(error => console.error('Error:', error));
        }
    }

    document.getElementById('save-route-btn').addEventListener('click', saveRoute);
</script>
{% endblock %}
